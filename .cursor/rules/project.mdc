---
description: 
globs: 
alwaysApply: true
---
# About this repo:
This project is a TCP Server for Login server and Game server for Lineage2 game. It's an emulation based on a known Rust project that is on development. I will be refering to that project as the RUST project or similar.
Project is divided into Core, Login and Server modules.

# How to work with me:
0. On our first ever message always take a look into `src/` folder to have a full context of our current implementation.
1. Never do a whole project restructure without asking me (if you plan to create or edit more than 5 files you need to tell me first, and give me a reason)
2. I like to do small steps at a time, this way I can follow you and understand what are you doing.
3. I'm a senior software eng with more than 10 years of exp, but I'm not a machine like you.
4. prefer composition over inheritance
5. Don't write tests unless I ask you to do it !

# AVOID
1. never say you fixed something until we can confirm it on execution or build time (I hate when you say "bug fixed!" just because you change code and no real test has been made)

# Key Files and Paths Reference

Based on implementing the ServerList packet handlers, here are the key paths and files that are essential for understanding and working with your L2 middlewares project:

## ğŸ—ï¸ Core Architecture (Most Important)

### Packet System Foundation
- `src/core/packets/packet.hpp` - Base interfaces for all packets (`ReadablePacket`, `SendablePacket`)
- `src/core/network/packet_buffer.hpp` - Packet serialization/deserialization interfaces
- `src/login/packets/packet_factory.hpp/cpp` - Central packet creation and RSA handling

### Network Layer Foundation
- `src/core/network/base_client_connection.hpp/cpp` - Base connection interface
- `src/core/network/base_connection_manager.hpp/cpp` - Base connection management

## ğŸ” Login Server Core (High Priority)

### Server Management
- `src/login/server/login_server.hpp/cpp` - Main server entry point and lifecycle
- `src/login/network/login_connection_manager.hpp/cpp` - Login-specific connection management
- `src/login/network/login_client_connection.hpp/cpp` - **CRITICAL** - All client interaction logic

### Data Management
- `src/login/server/game_server_manager.hpp/cpp` - Game server registration and management
- `src/login/data/server_data.hpp/cpp` - Core data structures (`ServerData`, enums)

## ğŸ“¦ Packet Implementation Patterns

### Request Packets (Client â†’ Server)
- `src/login/packets/requests/auth_login_packet.hpp/cpp` - RSA decryption example
- `src/login/packets/requests/request_auth_gg.hpp/cpp` - Simple packet example
- `src/login/packets/requests/request_server_list.hpp/cpp` - Basic data packet

### Response Packets (Server â†’ Client)
- `src/login/packets/responses/init_packet.hpp/cpp` - Complex packet with RSA keys
- `src/login/packets/responses/login_ok_response.hpp/cpp` - Session key handling
- `src/login/packets/responses/server_list_response.hpp/cpp` - Dynamic data serialization

## ğŸ”§ Build & Configuration
- `CMakeLists.txt` - Project structure and dependencies
- `vcpkg.json` - External dependencies

## ğŸ“ Directory Structure Patterns
```
src/
â”œâ”€â”€ core/ # Shared across login/game servers
â”‚ â”œâ”€â”€ packets/ # Base packet interfaces
â”‚ â”œâ”€â”€ network/ # Base networking classes
â”‚ â”œâ”€â”€ encryption/ # RSA, Blowfish, checksums
â”‚ â””â”€â”€ utils/ # Session keys, utilities
â”œâ”€â”€ login/ # Login server specific
â”‚ â”œâ”€â”€ server/ # Server management & game server tracking
â”‚ â”œâ”€â”€ network/ # Login connection handling
â”‚ â”œâ”€â”€ packets/ # Login-specific packets
â”‚ â”‚ â”œâ”€â”€ requests/ # Client â†’ Server packets
â”‚ â”‚ â””â”€â”€ responses/ # Server â†’ Client packets
â”‚ â””â”€â”€ data/ # Login data structures
â””â”€â”€ game/ # Game server (future)
```
## ğŸ¯ Key Learning Points for Future Work

### Adding New Packets - Follow This Pattern:
1. **Create packet classes** in `src/login/packets/requests|responses/`
2. **Update PacketFactory** in `packet_factory.hpp/cpp`
3. **Add handler method** in `login_client_connection.cpp`
4. **Update switch statement** in `handle_complete_packet()`
5. **Update CMakeLists.txt** with new source files

### Most Important Files to Understand:
1. `src/login/network/login_client_connection.cpp` - **This is the heart of all client interaction**
2. `src/login/packets/packet_factory.cpp` - **All packet creation flows through here**
3. `src/login/server/login_server.cpp` - **Server initialization and component wiring**

### Common Integration Points:
- **State management**: `LoginClientConnection::LoginState` enum
- **Packet routing**: `handle_complete_packet()` switch statement
- **Manager access**: Connection â†’ ConnectionManager â†’ GameServerManager chain
- **Error handling**: `send_login_fail()` and `force_disconnect()` patterns

### Encryption Flow Understanding:
- `src/core/encryption/rsa_manager.cpp` - RSA key handling
- `src/core/encryption/login_encryption.cpp` - Blowfish encryption
- `src/core/encryption/l2_checksum.cpp` - Packet integrity

This structure shows your project follows a **clean separation of concerns** with core networking abstractions and login-specific implementations. The packet factory pattern centralizes complex RSA handling, while the connection classes handle state management and business logic.

For future conversations, focusing on these files will give the fastest understanding of how to extend functionality! ğŸš€
